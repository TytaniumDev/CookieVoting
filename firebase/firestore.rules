rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is a global admin (for production collections)
    // Helper function to check if user is a global admin (for production collections)
    function isGlobalAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }
    
    // Helper function to check if user is a test admin (for test collections)
    // In test mode, any authenticated user (including anonymous) can be a test admin
    function isTestAdmin() {
      // Check if document exists and user is authenticated
      return request.auth != null && (
        // If test_system/admins doesn't exist, allow any authenticated user (for initial setup)
        !exists(/databases/$(database)/documents/test_system/admins) ||
        // Otherwise check if user is in the admin list
        (get(/databases/$(database)/documents/test_system/admins).data.userIds != null
          && request.auth.uid in get(/databases/$(database)/documents/test_system/admins).data.userIds)
      );
    }
    
    // Helper function to check if user can create/update test admin document
    function canManageTestAdmins() {
      // Allow any authenticated user to create if document doesn't exist
      // Allow test admins to update if document exists
      return request.auth != null && (
        !exists(/databases/$(database)/documents/test_system/admins) ||
        isTestAdmin()
      );
    }
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if collection is a test collection
    function isTestCollection(collectionName) {
      return collectionName.matches('test_.*');
    }
    

    
    // Test system collection - admins management (test database)
    match /test_system/admins {
      // Allow any authenticated user (including anonymous) to create/update (for initial setup)
      // Use request.auth != null directly to avoid any issues with helper functions
      allow create, update: if request.auth != null 
        && request.resource.data.userIds != null
        && request.resource.data.userIds is list;
      
      // Allow read if authenticated (so test user can check if they're admin)
      allow read: if request.auth != null;
      
      // Only test admins can delete
      allow delete: if isTestAdmin();
    }
    
    // Events collection - public read, global admin write (production)
    match /events/{eventId} {
      // Allow anyone to read event metadata (needed for voting)
      allow read: if true;
      
      // Only allow admins to create events
      allow create: if isGlobalAdmin();
      
      // Only allow updates/deletes if user is a global admin
      allow update, delete: if isGlobalAdmin();
      
      // Categories subcollection - public read, global admin write
      match /categories/{categoryId} {
        // Allow anyone to read categories (needed for voting)
        allow read: if true;
        
        // Only allow writes if user is a global admin
        allow write: if isGlobalAdmin();
      }
      
      // Votes subcollection - completely open for voting (anyone can vote)
      match /votes/{voteId} {
        // Allow anyone (including unauthenticated users) to create/update votes
        // No restrictions - voting is completely open
        allow create, update: if true;
        
        // Allow anyone to read votes (for results)
        allow read: if true;
        
        // Allow global admins to delete votes (for event deletion)
        allow delete: if isGlobalAdmin();
      }
      
      // Bakers subcollection - public read, global admin write
      match /bakers/{bakerId} {
        // Allow anyone to read bakers (needed for voting)
        allow read: if true;
        
        // Only allow writes if user is a global admin
        // For development/emulator, we'll allow any authenticated user if the admin claim isn't set
        allow write: if isGlobalAdmin() || request.auth != null;
      }

      // Cookies subcollection - public read, global admin write
      match /cookies/{cookieId} {
        // Allow anyone to read cookies (needed for voting)
        allow read: if true;
        
        // Writes (tagging) regulated
        allow write: if isGlobalAdmin() || request.auth != null;
      }
    }

    // Images collection - metadata for uploaded images
    match /images/{imageId} {
      // Allow anyone to read images
      allow read: if true;
      
      // Allow authenticated users to upload/manage images
      allow write: if request.auth != null; 
    }
    
    // Test events collection - allow authenticated users (including anonymous) for testing (test database)
    match /test_events/{eventId} {
      // Allow anyone to read test events (for testing UI)
      allow read: if true;
      
      // Allow any authenticated user (including anonymous) to create/delete test events (for testing)
      // Security: Anonymous auth will be disabled in production
      allow create, delete, update: if request.auth != null;
      
      // Categories subcollection - allow authenticated users for testing
      match /categories/{categoryId} {
        allow read: if true;
        allow write: if request.auth != null;
      }
      
      // Votes subcollection - completely open for voting (anyone can vote)
      match /votes/{voteId} {
        // Allow anyone (including unauthenticated users) to create/update votes
        // No restrictions - voting is completely open
        allow create, update: if true;
        
        // Allow anyone to read votes (for results)
        allow read: if true;
        
        // Allow authenticated users to delete votes (for testing)
        allow delete: if request.auth != null;
      }
      
      // Bakers subcollection - allow authenticated users for testing
      match /bakers/{bakerId} {
        allow read: if true;
        allow write: if request.auth != null;
      }
    }
    
    // Image detections collection - stores automatic cookie detection results
    // Public read (anyone can read detection results), write only by Firebase Functions (admin)
    match /image_detections/{detectionId} {
      // Allow anyone to read detection results (needed for ImageTagger)
      allow read: if true;
      
      // Only Firebase Functions (admin) can write - no client writes allowed
      // In practice, this will be written by the Storage trigger function
      allow write: if false; // Client writes disabled, only functions can write
    }
    
    // Detection jobs collection - tracks async detection job progress
    match /detection_jobs/{jobId} {
      // Allow authenticated users to read job status
      allow read: if request.auth != null;
      
      // Only Firebase Functions can write job status
      allow write: if false; // Client writes disabled, only functions can write
    }
  }
}

