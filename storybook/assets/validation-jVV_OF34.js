import{j as I,l as i,m as p,n as d,p as D,q as _,t as R,b as E,v,w as b}from"./firebase-DgwybkJe.js";const n=[];for(let e=0;e<256;++e)n.push((e+256).toString(16).slice(1));function T(e,t=0){return(n[e[t+0]]+n[e[t+1]]+n[e[t+2]]+n[e[t+3]]+"-"+n[e[t+4]]+n[e[t+5]]+"-"+n[e[t+6]]+n[e[t+7]]+"-"+n[e[t+8]]+n[e[t+9]]+"-"+n[e[t+10]]+n[e[t+11]]+n[e[t+12]]+n[e[t+13]]+n[e[t+14]]+n[e[t+15]]).toLowerCase()}let h;const w=new Uint8Array(16);function P(){if(!h){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");h=crypto.getRandomValues.bind(crypto)}return h(w)}const U=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),A={randomUUID:U};function O(e,t,r){e=e||{};const o=e.random??e.rng?.()??P();if(o.length<16)throw new Error("Random bytes length must be >= 16");return o[6]=o[6]&15|64,o[8]=o[8]&63|128,T(o)}function M(e,t,r){return A.randomUUID&&!e?A.randomUUID():O(e)}async function $(e,t,r){const o=d(i,"events",e,"categories",t);await R(o,{cookies:r})}function k(){return"system/admins"}async function x(){const e=k(),t=d(i,e);try{const r=await D(t);return r.exists()?r.data().userIds||[]:[]}catch(r){return console.warn("Could not read global admins document:",r),[]}}async function G(e){return(await x()).includes(e)}async function V(e,t,r){if(console.log(`[addCategory] Starting - eventId: ${e}, name: ${t}`),!E.currentUser)throw console.error("[addCategory] âŒ User not authenticated"),new Error("You must be signed in to add categories");const o=E.currentUser.uid;console.log(`[addCategory] User authenticated: ${o}`);const a=await G(o);if(console.log(`[addCategory] User is admin: ${a}`),!a)throw console.error("âŒ Permission denied: User is not a global admin"),console.log("ðŸ“‹ Your User UID:",o),E.currentUser.email&&console.log("ðŸ“§ Your Email:",E.currentUser.email),console.log("ðŸ”§ To fix this:"),console.log("   1. Go to Firebase Console â†’ Firestore Database"),console.log("   2. Navigate to: system/admins"),console.log("   3. Add this UID to the userIds array:",o),new Error("Permission denied: You must be a global admin to add categories");const c=M();console.log(`[addCategory] Generated category ID: ${c}`);const s=await L(e),l=s.reduce((m,y)=>Math.max(m,y.order||0),-1);console.log(`[addCategory] Existing categories: ${s.length}, max order: ${l}`);const u={id:c,name:t,imageUrl:r,cookies:[],order:l+1},g=d(i,"events",e,"categories",c);console.log(`[addCategory] Writing to: events/${e}/categories/${c}`);try{return await v(g,u),console.log(`[addCategory] âœ… Successfully created category: ${c} - ${t}`),u}catch(m){const y=m;throw console.error("[addCategory] âŒ Failed to write category:",m),console.error(`[addCategory] Error code: ${y.code}, message: ${y.message}`),y.code==="permission-denied"&&console.error("[addCategory] Permission denied - check Firestore rules"),m}}async function L(e){const t=_(I(i,"events",e,"categories"));return(await p(t)).docs.map(a=>a.data()).sort((a,c)=>{const s=a.order??1/0,l=c.order??1/0;return s-l})}function C(e){if(!(!e||!Array.isArray(e)||e.length===0))try{return e.map(t=>{if(typeof t=="object"&&"x"in t&&"y"in t)return[t.x,t.y];if(Array.isArray(t)&&t.length===2)return[t[0],t[1]];throw new Error(`Invalid polygon point format: ${JSON.stringify(t)}`)})}catch(t){console.warn("Error converting polygon from Firestore format:",t);return}}function F(e){try{if(e.includes("storage.googleapis.com")){const o=e.split("storage.googleapis.com/");if(o.length>1)return o[1].split("?")[0]}const t=e.split("/"),r=t.findIndex(o=>o==="o");if(r!==-1&&r<t.length-1){const o=t[r+1].split("?")[0];return decodeURIComponent(o)}return null}catch(t){return console.error("Error extracting file path from URL:",t),null}}async function Y(e){try{console.log(`[getImageDetectionResults] Attempting to get results for imageUrl: ${e}`);const t=F(e);if(!t)return console.warn("[getImageDetectionResults] Could not extract file path from URL:",e),null;console.log(`[getImageDetectionResults] Extracted filePath: ${t}`);const r=t.replace(/\//g,"_").replace(/\./g,"_");console.log(`[getImageDetectionResults] Generated detectionDocId: ${r}`);const o=d(i,"image_detections",r),a=await D(o);if(console.log(`[getImageDetectionResults] Document exists: ${a.exists()}`),a.exists()){const s=a.data().detectedCookies||null;return s&&Array.isArray(s)?(console.log(`[getImageDetectionResults] Found ${s.length} detected cookies`),s.map(u=>{const g={...u,polygon:C(u.polygon)};return g.polygon&&console.log(`[getImageDetectionResults] Cookie has polygon with ${g.polygon.length} points`),g})):s}return null}catch(t){return console.error("Error fetching detection results:",t),null}}async function B(){try{const e=I(i,"image_detections");return(await p(e)).docs.map(r=>{const o=r.data(),c=(o.detectedCookies||[]).map(s=>({...s,polygon:C(s.polygon)}));return{id:r.id,filePath:o.filePath||"",imageUrl:o.imageUrl||"",detectedCookies:c,count:o.count||c.length,detectedAt:o.detectedAt,contentType:o.contentType}})}catch(e){throw console.error("Error fetching all image detections:",e),e}}async function q(e,t){const r=t,o={id:r,name:t};return await v(d(i,"events",e,"bakers",r),o),o}async function j(e,t){await b(d(i,"events",e,"bakers",t))}async function z(e){const t=_(I(i,"events",e,"bakers"));return(await p(t)).docs.map(o=>o.data())}const f={MAX_IMAGE_SIZE_MB:5,MAX_IMAGE_SIZE_BYTES:5*1024*1024,ALLOWED_IMAGE_TYPES:["image/jpeg","image/jpg","image/png","image/webp","image/gif"],DEFAULT_MAKER_NAME:"Unknown",ERROR_MESSAGES:{EVENT_NOT_FOUND:"Event not found",FAILED_TO_LOAD:"Failed to load data. Please try again.",FAILED_TO_SAVE:"Failed to save. Please try again.",FAILED_TO_DELETE:"Failed to delete. Please try again.",FAILED_TO_UPLOAD:"Failed to upload image. Please try again.",IMAGE_TOO_LARGE:"Image is too large. Maximum size is 5MB.",INVALID_IMAGE_TYPE:"Invalid image type. Please use JPEG, PNG, WebP, or GIF.",INVALID_ADMIN_CODE:"Invalid admin code. Please try again.",VOTING_COMPLETED:"This event is no longer accepting votes.",VOTE_INCOMPLETE:"Please vote in all categories before submitting!",NETWORK_ERROR:"Network error. Please check your connection and try again."},SUCCESS_MESSAGES:{EVENT_CREATED:"Event created successfully!",CATEGORY_ADDED:"Category added successfully!",COOKIES_SAVED:"Cookie tags saved successfully!",VOTES_SUBMITTED:"Votes submitted successfully!",EVENT_DELETED:"Event deleted successfully!"},MEDALS:["ðŸ¥‡","ðŸ¥ˆ","ðŸ¥‰"]};function W(e){return e.size>f.MAX_IMAGE_SIZE_BYTES?{valid:!1,error:f.ERROR_MESSAGES.IMAGE_TOO_LARGE}:f.ALLOWED_IMAGE_TYPES.includes(e.type)?{valid:!0}:{valid:!1,error:f.ERROR_MESSAGES.INVALID_IMAGE_TYPE}}function S(e){return e.trim().replace(/[<>]/g,"")}function K(e){const t=S(e);return t?t.length>100?{valid:!1,error:"Category name must be 100 characters or less"}:{valid:!0}:{valid:!1,error:"Category name cannot be empty"}}function X(e){const t=S(e);return t?t.length>50?{valid:!1,error:"Maker name must be 50 characters or less"}:{valid:!0}:{valid:!1,error:"Maker name cannot be empty"}}export{f as C,B as a,L as b,z as c,W as d,K as e,V as f,Y as g,X as h,q as i,j as r,S as s,$ as u,M as v};
