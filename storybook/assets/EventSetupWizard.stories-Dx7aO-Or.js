import{j as o}from"./jsx-runtime-u17CrQMm.js";import{r as b,R as Je}from"./iframe-Bm-1nfva.js";import{r as Qe,u as et,e as tt,i as at,j as ot,k as nt,l as st}from"./firebase-DgwybkJe.js";import{v as Me,a as pe,b as Ie,c as Be,C as oe,u as xe,d as rt,e as it,s as Ue,f as ct,h as lt,i as dt,r as gt}from"./validation-jVV_OF34.js";import{c as mt,I as ut}from"./ImageWithDetections-C796q3Q4.js";import{w as Fe}from"./firebase-decorator-zlxdyja1.js";import{B as _e}from"./chunk-JMJ3UQ3L-DVVcMVDb.js";import"./preload-helper-PPVm8Dsz.js";async function pt(f,M){const D=f.name.split(".").pop(),X=`${Me()}.${D}`,$=Qe(at,`${M}/${X}`),m=await et($,f);return await tt(m.ref)}function ht(f){const m=[],y=(v,L,k,j)=>{const F=!(v+3.5<k-1||v>k+3.5+1),B=Math.abs(L-j)<25;return F&&B};return f.forEach((v,L)=>{const{bounds:k}=v,j=k.centerX,B=k.bottomY+1,ce=B+3.5>100;let le=!1;if(!ce)for(let d=0;d<m.length;d++){const O=m[d];if(y(B,j,O.top,O.left)){le=!0;break}}if(!ce&&!le){m.push({top:Math.min(100,B),left:j,anchor:"bottom"});return}const K=k.topLeftY,E=Math.max(0,K-1-3.5);let S=!1;for(let d=0;d<m.length;d++){const O=m[d];if(y(E,j,O.top,O.left)){S=!0;break}}if(!S){m.push({top:E,left:j,anchor:"top"});return}const x=m.filter(d=>Math.abs(B-d.top)<3.5*2.5);let I=0;if(x.length>0){const d=x.reduce((G,R)=>G+R.left,0)/x.length,O=j>d?1:-1,de=Math.min(15,Math.abs(j-d)+8);I=O*de;const N=j+I;if(m.some(G=>y(B,N,G.top,G.left))){I=-I;const G=j+I;m.some(z=>y(B,G,z.top,z.left))&&(I=(L%2===0?1:-1)*10)}}else I=(L%2===0?1:-1)*8;m.push({top:Math.min(100,B),left:Math.max(0,Math.min(100,j+I)),anchor:"bottom"})}),m}function ft(f,M){return M?mt(M):{topLeftX:f.x-4,topLeftY:f.y-4,bottomY:f.y+4,centerX:f.x}}const yt="_wizard_aibey_1",Ct="_header_aibey_9",bt="_steps_aibey_21",kt="_step_aibey_21",vt="_clickable_aibey_49",xt="_stepNumber_aibey_53",Nt="_active_aibey_72",_t="_completed_aibey_78",Et="_stepLabel_aibey_83",wt="_content_aibey_100",Tt="_error_aibey_104",jt="_stepContent_aibey_113",St="_instruction_aibey_134",It="_fileInput_aibey_140",Bt="_imageGrid_aibey_158",Ut="_imageCard_aibey_165",At="_removeButton_aibey_179",Mt="_uploadedBadge_aibey_203",Ft="_categoryNameGrid_aibey_216",Lt="_categoryNameCard_aibey_223",Ot="_input_aibey_237",$t="_bakerInput_aibey_254",Dt="_buttonPrimary_aibey_266",Rt="_bakerList_aibey_270",zt="_bakerCard_aibey_277",Pt="_categoryNavigation_aibey_322",Wt="_categoryTitle_aibey_334",Ht="_navButton_aibey_362",Gt="_taggingWorkspace_aibey_386",qt="_imageContainer_aibey_393",Yt="_taggingImage_aibey_403",Xt="_markerNumber_aibey_423",Kt="_markerName_aibey_440",Vt="_progressBar_aibey_488",Zt="_progressDot_aibey_496",Jt="_tagged_aibey_512",Qt="_actions_aibey_523",ea="_buttonSecondary_aibey_533",n={wizard:yt,header:Ct,steps:bt,step:kt,clickable:vt,stepNumber:xt,active:Nt,completed:_t,stepLabel:Et,content:wt,error:Tt,stepContent:jt,instruction:St,fileInput:It,imageGrid:Bt,imageCard:Ut,removeButton:At,uploadedBadge:Mt,categoryNameGrid:Ft,categoryNameCard:Lt,input:Ot,bakerInput:$t,buttonPrimary:Dt,bakerList:Rt,bakerCard:zt,categoryNavigation:Pt,categoryTitle:Wt,navButton:Ht,taggingWorkspace:Gt,imageContainer:qt,taggingImage:Yt,markerNumber:Xt,markerName:Kt,progressBar:Vt,progressDot:Zt,tagged:Jt,actions:Qt,buttonSecondary:ea};function Ne(f,M){const X=(y=>{try{const v=y.match(/([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})/i);if(v)return v[1];const k=new URL(y.split("?")[0]).pathname.split("/");return k[k.length-1].split(".")[0]}catch{return y}})(f),$=Math.round(M.x*10)/10,m=Math.round(M.y*10)/10;return`detected_${X}_${$}_${m}`}function Ae(f,M){return M.map(D=>({...D,id:D.id||Ne(f,D)}))}function Le({eventId:f,eventName:M,onComplete:D,onCancel:X,initialCategoryId:$}){const[m,y]=b.useState("upload"),[v,L]=b.useState([]),[k,j]=b.useState([]),[F,B]=b.useState(!1),[W,ce]=b.useState(!0),[le,K]=b.useState(0),[E,S]=b.useState(0),[x,I]=b.useState({}),[d,O]=b.useState([]),[de,N]=b.useState(null),[he,G]=b.useState(null),[R,z]=b.useState([]),[Oe,q]=b.useState(!1),[te,V]=b.useState(null),[ge,Z]=b.useState(!1),[fe,J]=b.useState(null),[$e,Ee]=b.useState(!1),[me,De]=b.useState({}),Re=b.useRef(null),ae=b.useRef([]),ye=b.useRef(null);b.useEffect(()=>{ae.current=ae.current.slice(0,v.length)},[v.length]),b.useEffect(()=>{(async()=>{try{const a=await Ie(f);if(a.length>0){O(a);const i=a.map(c=>({file:{},preview:c.imageUrl,uploaded:!0,imageUrl:c.imageUrl,categoryName:c.name}));L(i);const r=await Be(f),e=new Map;r.forEach(c=>{e.set(c.name,{id:c.id,name:c.name})}),a.forEach(c=>{c.cookies.forEach(h=>{h.makerName&&h.makerName!==oe.DEFAULT_MAKER_NAME&&(e.has(h.makerName)||e.set(h.makerName,{id:h.makerName,name:h.makerName}))})});const s=Array.from(e.values());j(s);const l={};if(a.forEach(c=>{l[c.id]={},c.cookies.forEach(h=>{const u=e.get(h.makerName);u&&(l[c.id][u.id]||(l[c.id][u.id]=[]),l[c.id][u.id].push(h))})}),I(l),$){const c=a.findIndex(h=>h.id===$);c!==-1&&s.length>0?(y("tagCookies"),K(0),S(c)):c!==-1&&s.length===0?y("addBakers"):s.length>0?(y("tagCookies"),K(0),S(0)):a.length>0?y("addBakers"):y("nameCategories")}else s.length>0?(y("tagCookies"),K(0),S(0)):a.length>0?y("addBakers"):y("nameCategories")}}catch(a){console.error("Failed to load existing data:",a),N("Failed to load event data")}finally{ce(!1)}})()},[f,$]),b.useEffect(()=>{if(m!=="tagCookies"||d.length===0||W||$)return;(async()=>{try{const a=await pe(),i=r=>{try{const e=r.match(/([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})/i);if(e)return e[1];const l=new URL(r.split("?")[0]).pathname.split("/");return l[l.length-1].split(".")[0]}catch{return null}};for(let r=0;r<d.length;r++){const e=d[r],s=i(e.imageUrl),l=s?a.find(u=>i(u.imageUrl)===s||u.imageUrl===e.imageUrl):a.find(u=>u.imageUrl===e.imageUrl);if(!l||l.detectedCookies.length===0){S(r);return}const c=Object.values(x[e.id]||{}).flat();if(!l.detectedCookies.every(u=>c.some(_=>Math.sqrt(Math.pow(_.x-u.x,2)+Math.pow(_.y-u.y,2))<5))){S(r);return}}S(0)}catch(a){console.error("[EventSetupWizard] Error finding first incomplete category:",a),S(0)}})()},[m,d,x,W,$]),b.useEffect(()=>{if(m!=="tagCookies"||d.length===0||W)return;(async()=>{try{const a=await pe(),i=e=>{try{const s=e.match(/([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})/i);if(s)return s[1];const c=new URL(e.split("?")[0]).pathname.split("/");return c[c.length-1].split(".")[0]}catch{return null}},r={};for(const e of d){console.log(`[CategoryCompletion] Checking category: ${e.name} (${e.id})`);const s=i(e.imageUrl);console.log(`[CategoryCompletion] Category file identifier: ${s}`),console.log(`[CategoryCompletion] Category image URL: ${e.imageUrl}`);const l=s?a.find(g=>i(g.imageUrl)===s||g.imageUrl===e.imageUrl):a.find(g=>g.imageUrl===e.imageUrl);if(!l){console.log(`[CategoryCompletion] âœ— No matching detection found for category ${e.name}`),r[e.id]=!0;continue}if(l.detectedCookies.length===0){console.log(`[CategoryCompletion] âœ“ Category ${e.name} has no detected cookies - marked complete`),r[e.id]=!0;continue}console.log(`[CategoryCompletion] Found ${l.detectedCookies.length} detected cookies for category ${e.name}`);const c=Ae(e.imageUrl,l.detectedCookies),h=x[e.id]||{};console.log("[CategoryCompletion] Tagged cookies structure:",Object.keys(h).map(g=>({bakerId:g,count:Array.isArray(h[g])?h[g].length:0})));const u=[];if(Object.values(h).forEach(g=>{Array.isArray(g)&&u.push(...g)}),console.log(`[CategoryCompletion] Total tagged cookies (across all bakers): ${u.length}`),u.length===0){console.log(`[CategoryCompletion] âœ— Category ${e.name} has detected cookies but no tagged cookies - marked incomplete`),r[e.id]=!1;continue}let _=!1;const w={...x};if(w[e.id]&&Object.values(w[e.id]).forEach(g=>{Array.isArray(g)&&g.forEach(A=>{if(!A.detectedCookieId){const be=c.find(P=>{const Q=A.x-P.x,ee=A.y-P.y;return Math.sqrt(Q*Q+ee*ee)<6});be?.id&&(A.detectedCookieId=be.id,_=!0)}})}),_){console.log(`[CategoryCompletion] Migrated ${e.name} tags to ID-based`),I(w);const g=Object.values(w[e.id]||{}).flat();xe(f,e.id,g).catch(A=>{console.error("[CategoryCompletion] Failed to save migrated tags:",A)})}const C=[],T=_?w[e.id]:h,U=[];Object.values(T||{}).forEach(g=>{Array.isArray(g)&&U.push(...g)});const Y=c.every(g=>{const A=g.id;if(!A)return C.push({detected:{x:g.x,y:g.y},reason:"No ID assigned"}),!1;if(U.find(P=>P.detectedCookieId===A))return!0;if(_)return C.push({detected:{x:g.x,y:g.y,id:A},reason:"No ID match found"}),!1;{let P=1/0,Q=!1;return U.forEach(ee=>{if(ee.detectedCookieId)return;const ke=ee.x-g.x,Se=ee.y-g.y,ve=Math.sqrt(ke*ke+Se*Se);ve<P&&(P=ve),ve<6&&(Q=!0)}),Q||C.push({detected:{x:g.x,y:g.y,id:A},reason:P===1/0?"No tagged cookies":`Closest distance: ${P.toFixed(2)}`}),Q}});Y?console.log(`[CategoryCompletion] âœ“ Category ${e.name} is COMPLETE - all ${c.length} detected cookies are tagged`):(console.log(`[CategoryCompletion] âœ— Category ${e.name} is INCOMPLETE`),console.log(`[CategoryCompletion] Unmatched detected cookies (${C.length}):`,C),console.log(`[CategoryCompletion] Detected cookies (${c.length}):`,c.map(g=>({id:g.id,x:g.x,y:g.y}))),console.log(`[CategoryCompletion] Tagged cookies (${U.length}):`,U.map(g=>({id:g.id,detectedCookieId:g.detectedCookieId,x:g.x,y:g.y,baker:g.makerName})))),r[e.id]=Y}De(r)}catch(a){console.error("[EventSetupWizard] Error checking category completion:",a)}})()},[m,d,x,W,R,E,f]),b.useEffect(()=>{(async()=>{if(m==="addBakers")try{const a=await Be(f),i=new Map;a.forEach(e=>{i.set(e.name,{id:e.id,name:e.name})}),d.forEach(e=>{e.cookies.forEach(s=>{s.makerName&&s.makerName!==oe.DEFAULT_MAKER_NAME&&(i.has(s.makerName)||i.set(s.makerName,{id:s.makerName,name:s.makerName}))})});const r=Array.from(i.values());j(r)}catch(a){console.error("Failed to refresh bakers:",a)}})()},[m,f,d]),b.useEffect(()=>{if(m!=="tagCookies"||d.length===0||W){Ee(!1);return}const t=Object.keys(me).length>0?d.every(a=>{const i=me[a.id];return i===void 0||i===!0}):!1;Ee(t)},[m,d,W,me]),b.useEffect(()=>{console.log("[EventSetupWizard] Detection useEffect triggered:",{step:m,currentCategoryIndex:E,categoriesLength:d.length,category:d[E]?.name});const t=d[E];if(m==="tagCookies"&&t){q(!0),console.log(`[EventSetupWizard] Setting up detection listener for category: ${t.name}, imageUrl: ${t.imageUrl}`),console.log(`[EventSetupWizard] Loading detection results for imageUrl: ${t.imageUrl}`),pe().then(s=>{console.log(`[EventSetupWizard] Loaded ${s.length} total detections`);const l=u=>{try{const _=u.match(/([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})/i);if(_)return _[1];const C=new URL(u.split("?")[0]).pathname.split("/");return C[C.length-1].split(".")[0]}catch{return null}},c=l(t.imageUrl);console.log(`[EventSetupWizard] Category file identifier: ${c}`);const h=c?s.find(u=>l(u.imageUrl)===c||u.imageUrl===t.imageUrl):s.find(u=>u.imageUrl===t.imageUrl);h?(console.log("[EventSetupWizard] âœ“ Found matching detection!",{detectionImageUrl:h.imageUrl,categoryImageUrl:t.imageUrl,cookieCount:h.detectedCookies.length}),z(h.detectedCookies),q(!1)):(console.warn("[EventSetupWizard] âœ— No matching detection found for imageUrl:",t.imageUrl),console.warn(`[EventSetupWizard] Category file identifier: ${c}`),console.warn("[EventSetupWizard] Available detections:",s.map(u=>({id:u.id,imageUrl:u.imageUrl,fileId:l(u.imageUrl)}))),z([]),q(!1))}).catch(s=>{console.error("[EventSetupWizard] Error loading all image detections:",s),z([]),q(!1)});const a=s=>{try{const l=s.match(/([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})/i);if(l)return l[1];const h=new URL(s.split("?")[0]).pathname.split("/");return h[h.length-1].split(".")[0]}catch{return null}},i=a(t.imageUrl),r=ot(st,"image_detections"),e=nt(r,async()=>{console.log("[EventSetupWizard] Detection document changed, reloading...");try{const s=await pe(),l=i?s.find(c=>a(c.imageUrl)===i||c.imageUrl===t.imageUrl):s.find(c=>c.imageUrl===t.imageUrl);if(l){console.log(`[EventSetupWizard] Watch: Updated to ${l.detectedCookies.length} cookies`);const c=Ae(t.imageUrl,l.detectedCookies);z(c)}else z([]);q(!1)}catch(s){console.error("[EventSetupWizard] Error reloading detections on change:",s),q(!1)}},s=>{console.error("[EventSetupWizard] Error watching detections:",s)});return()=>{console.log(`[EventSetupWizard] Cleaning up detection listener for category: ${t.name}`),e()}}else console.log("[EventSetupWizard] Not setting up detection listener - step:",m,"category:",t?.name),z([]),q(!1)},[m,d,E]);const ze=t=>{if(!t.target.files)return;const a=Array.from(t.target.files),i=[];for(const r of a){const e=rt(r);e.valid?i.push({file:r,preview:URL.createObjectURL(r),uploaded:!1}):N(e.error||oe.ERROR_MESSAGES.INVALID_IMAGE_TYPE)}L([...v,...i]),t.target.files&&(t.target.value="")},Pe=t=>{const a=[...v];URL.revokeObjectURL(a[t].preview),a.splice(t,1),L(a)},We=async()=>{if(v.length===0){N("Please upload at least one image");return}B(!0),N(null);try{const t=[],a="shared/cookies";for(const i of v){const r=await pt(i.file,a);t.push({...i,uploaded:!0,imageUrl:r})}L(t),y("nameCategories")}catch(t){console.error("Failed to upload images:",t),N(t instanceof Error?t.message:oe.ERROR_MESSAGES.FAILED_TO_UPLOAD)}finally{B(!1)}},He=(t,a)=>{const i=[...v];i[t].categoryName=a,L(i)},Ge=async()=>{const t=v.filter(a=>a.imageUrl&&a.categoryName&&a.categoryName.trim());for(let a=0;a<t.length;a++){const i=t[a];if(!i.categoryName||!i.categoryName.trim()){N(`Please name category ${a+1}`);return}const r=it(i.categoryName);if(!r.valid){N(r.error||`Invalid name for category ${a+1}`);return}}if(t.length===0){N("No images with category names to create");return}B(!0),N(null);try{const a=[];for(let r=0;r<t.length;r++){const e=t[r];if(e.imageUrl&&e.categoryName){const s=Ue(e.categoryName);console.log(`Creating category: ${s} with image: ${e.imageUrl}`);const l=await ct(f,s,e.imageUrl);console.log(`âœ… Created category: ${l.id} - ${l.name}`),a.push(l)}}console.log(`âœ… Created ${a.length} category/categories`);const i=await Ie(f);console.log(`ðŸ“‹ Total categories in database: ${i.length}`),O(i),y("addBakers")}catch(a){console.error("Failed to create categories:",a),N(a instanceof Error?a.message:oe.ERROR_MESSAGES.FAILED_TO_SAVE)}finally{B(!1)}},[ue,we]=b.useState(""),Te=async()=>{if(!ue.trim())return;const t=lt(ue);if(!t.valid){N(t.error||"Invalid baker name");return}const a=Ue(ue);if(k.find(r=>r.name===a)){N("Baker already exists");return}try{const r=await dt(f,a);j([...k,r]),we(""),N(null)}catch(r){console.error("Failed to save baker:",r),N(r instanceof Error?r.message:"Failed to save baker")}},qe=async t=>{try{await gt(f,t),j(k.filter(i=>i.id!==t));const a={...x};Object.keys(a).forEach(i=>{delete a[i][t]}),I(a)}catch(a){console.error("Failed to remove baker:",a),N(a instanceof Error?a.message:"Failed to remove baker")}},Ye=async()=>{if(p)try{const t={...x};t[p.id]={},I(t),await xe(f,p.id,[])}catch(t){console.error("Failed to reset tags:",t),N(t instanceof Error?t.message:"Failed to reset tags")}},Xe=()=>{if(k.length===0){N("Please add at least one baker");return}K(0),S(0),y("tagCookies")},Ce=k[le],p=d[E],Ke=(t,a)=>{t.stopPropagation(),p&&(V(a),J({x:t.clientX,y:t.clientY}),Z(!0))},Ve=async t=>{if(!p||!te)return;const a=te,i=k.find(C=>C.id===t);if(!i)return;const r={...x};r[p.id]||(r[p.id]={}),a.id||(a.id=Ne(p.imageUrl,a));let e=null,s=null;if(Object.entries(r[p.id]||{}).forEach(([C,T])=>{if(!Array.isArray(T))return;const U=T.find(g=>g.detectedCookieId===a.id);if(U){e=U,s=C;return}const Y=T.find(g=>g.detectedCookieId?!1:Math.sqrt(Math.pow(g.x-a.x,2)+Math.pow(g.y-a.y,2))<6);Y&&(e=Y,s=C)}),e!==null&&s!==null){const C=r[p.id][s];if(C&&Array.isArray(C)){const T=e;r[p.id][s]=C.filter(Y=>Y.id!==T.id);const U=r[p.id][s];U&&U.length===0&&delete r[p.id][s]}}r[p.id][t]||(r[p.id][t]=[]);const c={id:e!==null?e.id:Me(),number:0,makerName:i.name,x:a.x,y:a.y,detectedCookieId:a.id};r[p.id][t]=[...r[p.id][t],c],I(r),await Ze(p.id);const h=je(p.id),u={...x};u[p.id]={},h.forEach(C=>{const T=k.find(U=>U.name===C.makerName);T&&(u[p.id][T.id]||(u[p.id][T.id]=[]),u[p.id][T.id].push(C))}),I(u);const _=Object.values(u[p.id]||{}).flat();R.every(C=>_.some(T=>Math.sqrt(Math.pow(T.x-C.x,2)+Math.pow(T.y-C.y,2))<5))&&m==="tagCookies"&&E<d.length-1&&setTimeout(()=>{S(E+1)},500),Z(!1),V(null),J(null)};b.useEffect(()=>{const t=a=>{ge&&ye.current&&!ye.current.contains(a.target)&&(Z(!1),V(null),J(null))};if(ge)return document.addEventListener("mousedown",t),()=>{document.removeEventListener("mousedown",t)}},[ge]);const je=t=>{const a=x[t]||{},i=[];Object.entries(a).forEach(([e,s])=>{const l=k.find(c=>c.id===e);s.forEach(c=>{i.push({cookie:c,baker:l})})});const r=i.sort((e,s)=>{const l=e.cookie.y-s.cookie.y;return Math.abs(l)<15?e.cookie.x-s.cookie.x:l});return r.forEach(({cookie:e},s)=>{e.number=s+1}),r.map(({cookie:e})=>e)},Ze=async t=>{try{const a=je(t);await xe(f,t,a)}catch(a){console.error("Failed to autosave category:",a)}};return W?o.jsx("div",{className:n.wizard,children:o.jsx("div",{className:n.content,children:o.jsx("div",{style:{textAlign:"center",padding:"2rem"},children:"Loading event data..."})})}):o.jsxs("div",{className:n.wizard,children:[o.jsxs("div",{className:n.header,children:[o.jsxs("h1",{children:["Edit Event: ",M]}),o.jsxs("div",{className:n.steps,children:[o.jsxs("div",{className:`${n.step} ${m==="upload"?n.active:m==="nameCategories"||m==="addBakers"||m==="tagCookies"?n.completed:""} ${d.length>0?n.clickable:""}`,onClick:()=>d.length>0&&y("upload"),children:[o.jsx("span",{className:n.stepNumber,children:"1"}),o.jsx("span",{className:n.stepLabel,children:"Upload Images"})]}),o.jsxs("div",{className:`${n.step} ${m==="nameCategories"?n.active:m==="addBakers"||m==="tagCookies"?n.completed:""} ${d.length>0?n.clickable:""}`,onClick:()=>d.length>0&&y("nameCategories"),children:[o.jsx("span",{className:n.stepNumber,children:"2"}),o.jsx("span",{className:n.stepLabel,children:"Name Categories"})]}),o.jsxs("div",{className:`${n.step} ${m==="addBakers"?n.active:m==="tagCookies"?n.completed:""} ${d.length>0?n.clickable:""}`,onClick:()=>d.length>0&&y("addBakers"),children:[o.jsx("span",{className:n.stepNumber,children:"3"}),o.jsx("span",{className:n.stepLabel,children:"Add Bakers"})]}),o.jsxs("div",{className:`${n.step} ${m==="tagCookies"?n.active:""} ${d.length>0&&k.length>0?n.clickable:""}`,onClick:()=>d.length>0&&k.length>0&&y("tagCookies"),children:[o.jsx("span",{className:n.stepNumber,children:"4"}),o.jsx("span",{className:n.stepLabel,children:"Tag Cookies"})]})]})]}),o.jsxs("div",{className:n.content,children:[de&&o.jsx("div",{className:n.error,children:de}),m==="upload"&&o.jsxs("div",{className:n.stepContent,children:[o.jsx("h2",{children:"Upload Cookie Images"}),o.jsx("p",{className:n.instruction,children:"Upload all cookie images at once (typically ~10 images)"}),o.jsx("input",{ref:Re,type:"file",accept:"image/jpeg,image/jpg,image/png,image/webp,image/gif",multiple:!0,onChange:ze,className:n.fileInput,disabled:F}),v.length>0&&o.jsx("div",{className:n.imageGrid,children:v.map((t,a)=>o.jsxs("div",{className:n.imageCard,children:[o.jsx("img",{src:t.preview,alt:`Preview ${a+1}`}),o.jsx("button",{onClick:()=>Pe(a),className:n.removeButton,disabled:F,children:"Ã—"}),t.uploaded&&o.jsx("div",{className:n.uploadedBadge,children:"âœ“ Uploaded"})]},a))}),o.jsxs("div",{className:n.actions,children:[o.jsx("button",{onClick:X,className:n.buttonSecondary,disabled:F,children:"Cancel"}),d.length>0&&o.jsx("button",{onClick:()=>y("nameCategories"),className:n.buttonSecondary,disabled:F,children:"Next: Name Categories â†’"}),o.jsx("button",{onClick:We,disabled:F||v.length===0,className:n.buttonPrimary,children:F?"Uploading...":d.length>0?"Add More Images":`Upload ${v.length} Image${v.length!==1?"s":""}`})]})]}),m==="nameCategories"&&o.jsxs("div",{className:n.stepContent,children:[o.jsx("h2",{children:"Name Each Category"}),o.jsx("p",{className:n.instruction,children:'Give each image a category name (e.g., "Sugar Cookie", "Chocolate Chip")'}),o.jsx("div",{className:n.categoryNameGrid,children:v.map((t,a)=>o.jsxs("div",{className:n.categoryNameCard,children:[o.jsx("img",{src:t.preview,alt:`Category ${a+1}`}),o.jsx("input",{ref:i=>{ae.current[a]=i},type:"text",placeholder:`Category ${a+1} name`,value:t.categoryName||"",onChange:i=>He(a,i.target.value),onKeyDown:i=>{if(i.key==="Enter"){i.preventDefault();const r=a+1;r<v.length&&ae.current[r]&&ae.current[r]?.focus()}},className:n.input,maxLength:100})]},a))}),o.jsxs("div",{className:n.actions,children:[o.jsx("button",{onClick:()=>y("upload"),className:n.buttonSecondary,children:"â† Back"}),d.length>0&&o.jsx("button",{onClick:()=>y("addBakers"),className:n.buttonSecondary,disabled:F,children:"Next: Add Bakers â†’"}),o.jsx("button",{onClick:Ge,disabled:F||v.some(t=>!t.categoryName?.trim()),className:n.buttonPrimary,children:F?"Creating...":d.length>0?"Add More Categories":"Create Categories"})]})]}),m==="addBakers"&&o.jsxs("div",{className:n.stepContent,children:[o.jsx("h2",{children:"Add Bakers"}),o.jsx("p",{className:n.instruction,children:"List all bakers participating in this event"}),o.jsxs("div",{className:n.bakerInput,children:[o.jsx("input",{type:"text",placeholder:"Baker name",value:ue,onChange:t=>{we(t.target.value),N(null)},onKeyPress:t=>{t.key==="Enter"&&(t.preventDefault(),Te())},className:n.input,maxLength:50}),o.jsx("button",{onClick:Te,onMouseDown:t=>{t.preventDefault()},className:n.buttonPrimary,children:"Add Baker"})]}),k.length>0&&o.jsx("div",{className:n.bakerList,children:k.map(t=>o.jsxs("div",{className:n.bakerCard,children:[o.jsx("span",{children:t.name}),o.jsx("button",{onClick:()=>qe(t.id),className:n.removeButton,children:"Ã—"})]},t.id))}),o.jsxs("div",{className:n.actions,children:[o.jsx("button",{onClick:()=>y("nameCategories"),className:n.buttonSecondary,children:"â† Back"}),d.length>0&&k.length>0&&o.jsx("button",{onClick:()=>y("tagCookies"),className:n.buttonSecondary,children:"Next: Tag Cookies â†’"}),o.jsx("button",{onClick:Xe,disabled:k.length===0,className:n.buttonPrimary,children:d.length>0&&k.length>0?"Continue Tagging":"Start Tagging"})]})]}),m==="tagCookies"&&Ce&&p?o.jsxs("div",{className:n.stepContent,children:[o.jsxs("div",{className:n.categoryNavigation,children:[o.jsx("button",{onClick:()=>{E>0&&(S(E-1),setHasManuallyChangedBaker(!1))},disabled:E===0,className:n.navButton,children:"â† Previous"}),o.jsxs("div",{className:n.categoryTitle,children:[o.jsx("h3",{children:p?.name||""}),Ce&&o.jsx("div",{className:n.progressBar,children:d.map((t,a)=>{const i=me[t.id]===!0;return o.jsx("div",{className:`${n.progressDot} ${a===E?n.active:""} ${i?n.tagged:""}`,title:t.name,onClick:()=>S(a)},t.id)})})]}),o.jsx("button",{onClick:()=>{E<d.length-1&&(S(E+1),setHasManuallyChangedBaker(!1))},disabled:E===d.length-1,className:n.navButton,children:"Next â†’"})]}),o.jsxs("div",{className:n.taggingWorkspace,children:[p&&o.jsxs("div",{className:n.imageContainer,ref:ye,children:[Oe&&o.jsx("div",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",color:"white",fontSize:"0.9rem",zIndex:20},children:"Loading detection results..."}),(()=>{const t=R,a=p?Object.values(x[p.id]||{}).flat():[];return o.jsx(ut,{imageUrl:p.imageUrl,detectedCookies:t,onCookieClick:(i,r,e)=>{const s=i.id||Ne(p.imageUrl,i);a.some(c=>c.detectedCookieId===s?!0:c.detectedCookieId?!1:Math.sqrt(Math.pow(c.x-i.x,2)+Math.pow(c.y-i.y,2))<6)?(V(i),J({x:e.clientX,y:e.clientY}),Z(!0)):Ke(e,i)},className:n.taggingImage,borderColor:"transparent"})})(),p&&x[p.id]&&(()=>{const t=[];Object.entries(x[p.id]).forEach(([e,s])=>{const l=k.find(c=>c.id===e);s.forEach(c=>{t.push({cookie:c,baker:l})})});const i=t.sort((e,s)=>{const l=e.cookie.y-s.cookie.y;return Math.abs(l)<15?e.cookie.x-s.cookie.x:l}).map(({cookie:e,baker:s})=>{const l=R.find(u=>Math.sqrt(Math.pow(u.x-e.x,2)+Math.pow(u.y-e.y,2))<5),c=l?{x:l.x,y:l.y,width:l.width,height:l.height,polygon:l.polygon,confidence:l.confidence}:null,h=ft(e,c);return{cookie:e,baker:s,bounds:h}}),r=ht(i);return i.map(({cookie:e,baker:s,bounds:l},c)=>{const h=_=>{if(_.stopPropagation(),!p)return;let w=e.detectedCookieId?R.find(C=>C.id===e.detectedCookieId):void 0;if(w||(w=R.find(C=>Math.sqrt(Math.pow(C.x-e.x,2)+Math.pow(C.y-e.y,2))<6)),w){const C={x:w.x,y:w.y,width:w.width,height:w.height,polygon:w.polygon,confidence:w.confidence};V(C),J({x:_.clientX,y:_.clientY}),Z(!0)}},u=r[c];return o.jsxs(Je.Fragment,{children:[o.jsx("div",{className:n.markerNumber,style:{left:`${Math.max(0,l.topLeftX)}%`,top:`${Math.max(0,l.topLeftY)}%`,position:"absolute",zIndex:11},onClick:h,children:e.number}),s&&u&&o.jsx("div",{className:n.markerName,style:{left:`${Math.max(0,Math.min(100,u.left))}%`,top:`${Math.max(0,Math.min(100,u.top))}%`,position:"absolute",transform:"translate(-50%, 0)",zIndex:11},onClick:h,children:s.name})]},e.id)})})(),ge&&fe&&te&&p&&(()=>{const a=Object.values(x[p.id]||{}).flat().find(e=>Math.sqrt(Math.pow(e.x-te.x,2)+Math.pow(e.y-te.y,2))<5),i=a!==void 0;let r=null;return i&&Object.entries(x[p.id]||{}).forEach(([e,s])=>{s.some(l=>l.id===a.id)&&(r=e)}),o.jsxs("div",{style:{position:"fixed",left:`${Math.min(fe.x,window.innerWidth-200)}px`,top:`${Math.min(fe.y,window.innerHeight-300)}px`,background:"var(--color-bg-secondary, #1e293b)",border:"1px solid rgba(255, 255, 255, 0.2)",borderRadius:"6px",padding:"0.5rem",zIndex:1e3,boxShadow:"0 4px 6px rgba(0, 0, 0, 0.3)",minWidth:"150px",maxWidth:"200px"},onClick:e=>e.stopPropagation(),children:[o.jsx("div",{style:{fontSize:"0.875rem",color:"var(--color-text-secondary, #cbd5e1)",marginBottom:"0.5rem",padding:"0.25rem"},children:i?"Reassign baker:":"Assign to baker:"}),k.map(e=>o.jsxs("button",{onClick:()=>Ve(e.id),style:{display:"block",width:"100%",padding:"0.5rem",marginBottom:"0.25rem",background:e.id===r?"rgba(33, 150, 243, 0.2)":"rgba(255, 255, 255, 0.05)",border:e.id===r?"1px solid rgba(33, 150, 243, 0.4)":"1px solid rgba(255, 255, 255, 0.1)",borderRadius:"4px",color:e.id===r?"#90caf9":"white",cursor:"pointer",fontSize:"0.9rem",textAlign:"left"},onMouseEnter:s=>{e.id!==r&&(s.currentTarget.style.background="rgba(255, 255, 255, 0.1)")},onMouseLeave:s=>{e.id!==r&&(s.currentTarget.style.background="rgba(255, 255, 255, 0.05)")},children:[e.name," ",e.id===r?" (current)":""]},e.id)),o.jsx("button",{onClick:()=>{Z(!1),V(null),J(null)},style:{display:"block",width:"100%",padding:"0.5rem",marginTop:"0.5rem",background:"rgba(255, 255, 255, 0.05)",border:"1px solid rgba(255, 255, 255, 0.1)",borderRadius:"4px",color:"rgba(255, 255, 255, 0.7)",cursor:"pointer",fontSize:"0.875rem"},children:"Cancel"})]})})()]}),he&&o.jsx("div",{style:{marginTop:"1rem",padding:"0.75rem",background:"rgba(244, 67, 54, 0.2)",border:"1px solid rgba(244, 67, 54, 0.5)",borderRadius:"4px",color:"#ffcdd2",fontSize:"0.875rem"},children:he}),p&&Object.keys(x[p.id]||{}).length>0&&o.jsx("button",{onClick:Ye,style:{marginTop:"1rem",padding:"0.5rem 1rem",background:"rgba(220, 38, 38, 0.2)",border:"1px solid rgba(220, 38, 38, 0.4)",borderRadius:"4px",color:"#fca5a5",cursor:"pointer",fontSize:"0.875rem",fontWeight:500},onMouseEnter:t=>{t.currentTarget.style.background="rgba(220, 38, 38, 0.3)"},onMouseLeave:t=>{t.currentTarget.style.background="rgba(220, 38, 38, 0.2)"},children:"Reset Tags"})]}),o.jsx("div",{className:n.actions,children:$e?o.jsx("button",{onClick:D,className:n.buttonPrimary,children:"Done"}):null})]}):m==="tagCookies"?o.jsxs("div",{className:n.stepContent,children:[o.jsx("div",{className:n.error,children:Ce?p?"Loading...":"No categories found. Please add categories first.":"No bakers found. Please add bakers first."}),o.jsx("div",{className:n.actions,children:o.jsx("button",{onClick:()=>y("addBakers"),className:n.buttonSecondary,children:"â† Back to Add Bakers"})})]}):null]})]})}Le.__docgenInfo={description:"",methods:[],displayName:"EventSetupWizard",props:{eventId:{required:!0,tsType:{name:"string"},description:""},eventName:{required:!0,tsType:{name:"string"},description:""},onComplete:{required:!0,tsType:{name:"signature",type:"function",raw:"() => void",signature:{arguments:[],return:{name:"void"}}},description:""},onCancel:{required:!0,tsType:{name:"signature",type:"function",raw:"() => void",signature:{arguments:[],return:{name:"void"}}},description:""},initialCategoryId:{required:!1,tsType:{name:"string"},description:""},autoAdvance:{required:!1,tsType:{name:"boolean"},description:""}}};const{fn:H}=__STORYBOOK_MODULE_TEST__,la={title:"Organisms/EventSetupWizard",component:Le,decorators:[f=>o.jsx(_e,{children:o.jsx(f,{})})],parameters:{layout:"fullscreen",docs:{description:{component:`
A comprehensive multi-step wizard for setting up cookie voting events.

**Features:**
- **Step 1 - Upload Images**: Upload category images with drag-and-drop or file picker
- **Step 2 - Name Categories**: Assign names to each uploaded image/category
- **Step 3 - Add Bakers**: Add baker names that will be associated with cookies
- **Step 4 - Tag Cookies**: Tag cookies in each category image, optionally using AI detection

**Usage:**
This component is used in the admin interface to set up new voting events or edit existing ones.
It handles the complete workflow from image upload to cookie tagging.

**Firebase Integration:**
This component requires Firebase emulators to be running for full functionality.
Use the \`WithFirebaseEmulator\` story to test with real Firebase services.
        `}}},tags:["autodocs"],argTypes:{eventId:{control:"text",description:"Unique identifier for the event"},eventName:{control:"text",description:"Display name of the event"},onComplete:{action:"completed",description:"Callback when wizard is completed"},onCancel:{action:"cancelled",description:"Callback when wizard is cancelled"},initialCategoryId:{control:"text",description:"Optional category ID to start editing from"},autoAdvance:{control:"boolean",description:"Whether to auto-advance after tagging cookies"}}},ne={args:{eventId:"test-event-123",eventName:"Test Cookie Voting Event",onComplete:H(),onCancel:H(),autoAdvance:!1},parameters:{docs:{description:{story:`
Default state showing the wizard at the initial upload step.
Users can upload images for categories using drag-and-drop or the file picker.
        `}}}},se={decorators:[f=>o.jsx(_e,{children:o.jsx(f,{})}),Fe],args:{eventId:"storybook-test-event",eventName:"Storybook Test Event",onComplete:H(),onCancel:H(),autoAdvance:!1},parameters:{docs:{description:{story:`
This story uses the Firebase emulator to provide full functionality.
Make sure to start the Firebase emulators before viewing this story:
\`npm run emulators:start\`

The wizard will be able to:
- Upload images to Firebase Storage
- Save categories and bakers to Firestore
- Load existing event data
- Tag cookies with full persistence
        `}}}},re={args:{eventId:"test-event-auto",eventName:"Auto-Advance Test Event",onComplete:H(),onCancel:H(),autoAdvance:!0},parameters:{docs:{description:{story:`
This story shows the wizard with auto-advance enabled.
After tagging cookies in a category, the wizard will automatically
move to the next category or step.
        `}}}},ie={decorators:[f=>o.jsx(_e,{children:o.jsx(f,{})}),Fe],args:{eventId:"existing-event-123",eventName:"Existing Event",onComplete:H(),onCancel:H(),initialCategoryId:"category-1",autoAdvance:!1},parameters:{docs:{description:{story:`
This story demonstrates editing an existing event.
The wizard will load existing categories, bakers, and tagged cookies
from Firestore and allow editing them.

Note: This requires Firebase emulators to be running and the event
to exist in the emulator database.
        `}}}};ne.parameters={...ne.parameters,docs:{...ne.parameters?.docs,source:{originalSource:`{
  args: {
    eventId: 'test-event-123',
    eventName: 'Test Cookie Voting Event',
    onComplete: fn(),
    onCancel: fn(),
    autoAdvance: false
  },
  parameters: {
    docs: {
      description: {
        story: \`
Default state showing the wizard at the initial upload step.
Users can upload images for categories using drag-and-drop or the file picker.
        \`
      }
    }
  }
}`,...ne.parameters?.docs?.source},description:{story:`Default story showing the wizard in initial state (upload step)
Note: This story requires Firebase emulators for full functionality`,...ne.parameters?.docs?.description}}};se.parameters={...se.parameters,docs:{...se.parameters?.docs,source:{originalSource:`{
  decorators: [Story => <BrowserRouter>
        <Story />
      </BrowserRouter>, withFirebaseEmulator],
  args: {
    eventId: 'storybook-test-event',
    eventName: 'Storybook Test Event',
    onComplete: fn(),
    onCancel: fn(),
    autoAdvance: false
  },
  parameters: {
    docs: {
      description: {
        story: \`
This story uses the Firebase emulator to provide full functionality.
Make sure to start the Firebase emulators before viewing this story:
\\\`npm run emulators:start\\\`

The wizard will be able to:
- Upload images to Firebase Storage
- Save categories and bakers to Firestore
- Load existing event data
- Tag cookies with full persistence
        \`
      }
    }
  }
}`,...se.parameters?.docs?.source},description:{story:`Story with Firebase emulator integration
This story demonstrates the full wizard workflow with real Firebase services`,...se.parameters?.docs?.description}}};re.parameters={...re.parameters,docs:{...re.parameters?.docs,source:{originalSource:`{
  args: {
    eventId: 'test-event-auto',
    eventName: 'Auto-Advance Test Event',
    onComplete: fn(),
    onCancel: fn(),
    autoAdvance: true
  },
  parameters: {
    docs: {
      description: {
        story: \`
This story shows the wizard with auto-advance enabled.
After tagging cookies in a category, the wizard will automatically
move to the next category or step.
        \`
      }
    }
  }
}`,...re.parameters?.docs?.source},description:{story:`Story with auto-advance enabled
This story demonstrates the wizard with automatic progression after tagging`,...re.parameters?.docs?.description}}};ie.parameters={...ie.parameters,docs:{...ie.parameters?.docs,source:{originalSource:`{
  decorators: [Story => <BrowserRouter>
        <Story />
      </BrowserRouter>, withFirebaseEmulator],
  args: {
    eventId: 'existing-event-123',
    eventName: 'Existing Event',
    onComplete: fn(),
    onCancel: fn(),
    initialCategoryId: 'category-1',
    autoAdvance: false
  },
  parameters: {
    docs: {
      description: {
        story: \`
This story demonstrates editing an existing event.
The wizard will load existing categories, bakers, and tagged cookies
from Firestore and allow editing them.

Note: This requires Firebase emulators to be running and the event
to exist in the emulator database.
        \`
      }
    }
  }
}`,...ie.parameters?.docs?.source},description:{story:`Story for editing an existing event
This story demonstrates loading existing event data`,...ie.parameters?.docs?.description}}};const da=["Default","WithFirebaseEmulator","WithAutoAdvance","EditingExistingEvent"];export{ne as Default,ie as EditingExistingEvent,re as WithAutoAdvance,se as WithFirebaseEmulator,da as __namedExportsOrder,la as default};
